name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-sign-notarize:
    runs-on: macos-14
    env:
      PROJECT_PATH: macos-app/CursorOutline.xcodeproj
      SCHEME: CursorOutline
      APP_BUNDLE_NAME: Cursor Outline
      APP_EXECUTABLE_NAME: CursorOutline

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        env:
          APPLE_CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -euo pipefail
          required=(
            APPLE_CERTIFICATE_P12
            APPLE_CERTIFICATE_PASSWORD
            APPLE_SIGNING_IDENTITY
            APPLE_ID
            APPLE_APP_SPECIFIC_PASSWORD
            APPLE_TEAM_ID
          )
          for var in "${required[@]}"; do
            if [ -z "${!var:-}" ]; then
              echo "::error::Missing required secret: ${var}"
              exit 1
            fi
          done

      - name: Install Developer ID certificate
        env:
          APPLE_CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          set -euo pipefail

          CERT_PATH="$RUNNER_TEMP/developer-id.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/codesign.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 24)"

          if ! echo "$APPLE_CERTIFICATE_P12" | base64 --decode > "$CERT_PATH" 2>/dev/null; then
            echo "$APPLE_CERTIFICATE_P12" | base64 -D > "$CERT_PATH"
          fi

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -k "$KEYCHAIN_PATH" -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          LOGIN_KEYCHAIN="$(security login-keychain | tr -d '\"')"
          security list-keychains -d user -s "$KEYCHAIN_PATH" "$LOGIN_KEYCHAIN"
          security default-keychain -d user -s "$KEYCHAIN_PATH"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"

      - name: Validate app metadata
        run: |
          plutil -lint macos-app/CursorOutline/Info.plist

      - name: Build unsigned universal app
        run: |
          set -euo pipefail

          DERIVED_DATA_PATH="$RUNNER_TEMP/DerivedData"

          xcodebuild \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination 'generic/platform=macOS' \
            -derivedDataPath "$DERIVED_DATA_PATH" \
            build \
            ONLY_ACTIVE_ARCH=NO \
            ARCHS='arm64 x86_64' \
            CODE_SIGNING_ALLOWED=NO

          APP_PATH="$DERIVED_DATA_PATH/Build/Products/Release/$APP_BUNDLE_NAME.app"
          test -d "$APP_PATH"
          lipo -info "$APP_PATH/Contents/MacOS/$APP_EXECUTABLE_NAME"

          echo "APP_PATH=$APP_PATH" >> "$GITHUB_ENV"

      - name: Sign app with Developer ID
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        run: |
          set -euo pipefail

          codesign \
            --force \
            --deep \
            --options runtime \
            --timestamp \
            --sign "$APPLE_SIGNING_IDENTITY" \
            "$APP_PATH"

          codesign --verify --deep --strict --verbose=2 "$APP_PATH"

      - name: Create DMG artifact
        run: |
          set -euo pipefail

          DIST_DIR="$GITHUB_WORKSPACE/dist"
          STAGING_DIR="$DIST_DIR/dmg-root"
          DMG_NAME="CursorOutline-${GITHUB_REF_NAME}.dmg"
          DMG_PATH="$DIST_DIR/$DMG_NAME"

          rm -rf "$STAGING_DIR"
          mkdir -p "$STAGING_DIR"
          cp -R "$APP_PATH" "$STAGING_DIR/"
          ln -s /Applications "$STAGING_DIR/Applications"

          hdiutil create \
            -volname "Cursor Outline" \
            -srcfolder "$STAGING_DIR" \
            -ov \
            -format UDZO \
            "$DMG_PATH"

          echo "DMG_PATH=$DMG_PATH" >> "$GITHUB_ENV"

      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -euo pipefail

          xcrun notarytool submit "$DMG_PATH" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

      - name: Staple and validate DMG
        run: |
          set -euo pipefail

          xcrun stapler staple "$DMG_PATH"
          xcrun stapler validate "$DMG_PATH"
          spctl -a -vv -t open "$DMG_PATH"

      - name: Upload GitHub Release artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.DMG_PATH }}
          generate_release_notes: true

      - name: Cleanup signing keychain
        if: always()
        run: |
          if [ -n "${KEYCHAIN_PATH:-}" ] && [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH"
          fi
